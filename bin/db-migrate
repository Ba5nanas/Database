#!/usr/bin/env php
<?php
use Gt\Database\Connection\Settings;
use Gt\Database\Migration\Config;
use Gt\Database\Migration\Migrator;
/**
 * Database migration iterates over a set of incremental schema changes and
 * stores the currently-migrated schema version within the database itself.
 */
// The script must be run from the context of a project's root directory.
$repoBasePath = getcwd();
$autoloadPath = implode(DIRECTORY_SEPARATOR, [
	$repoBasePath,
	"vendor",
	"autoload.php",
]);
require($autoloadPath);

$forced = false;
if(!empty($argv[1])
&& ($argv[1] === "--force" || $argv[1] === "-f")) {
	$forced = true;
}

// Load the default config supplied by WebEngine, if available:
$webEngineConfig = new Config("$repoBasePath/vendor/phpgt/webengine/config.default.ini");
$config = new Config(
	"$repoBasePath/config.ini",
	[
		"database" => $webEngineConfig["database"] ?? [],
	]
);

$settings = new Settings(
	implode(DIRECTORY_SEPARATOR, [
		$repoBasePath,
		$config["database"]["query_path"]
	]),
	$config["database"]["dsn"],
	$config["database"]["schema"],
	$config["database"]["host"],
	$config["database"]["port"],
	$config["database"]["username"],
	$config["database"]["password"]
);

$migrationPath = implode(DIRECTORY_SEPARATOR, [
	$repoBasePath,
	$config["database"]["query_path"],
	$config["database"]["migration_path"],
]);
$migrationTable = $config["database"]["migration_table"];

$migrator = new Migrator($settings, $migrationPath, $migrationTable, $forced);
$migrator->createMigrationTable();
$migrationCount = $migrator->getMigrationCount();
$migrationFileList = $migrator->getMigrationFileList();
$migrator->checkIntegrity($migrationFileList, $migrationCount);
$migrator->performMigration($migrationFileList, $migrationCount);